<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é»é¤ç³»çµ±</title>
  <link href='https://cdn.boxicons.com/3.0.6/fonts/basic/boxicons.min.css' rel='stylesheet'>
  <style>
    /* 1. å°è¦½åˆ—èˆ‡åŸºç¤æ¨£å¼ä¿æŒä¸è®Š */
    .navbar {
      position: fixed; 
      top: 0; left: 0;
      width: 100%; height: 65px;
      display: flex; align-items: center;
      background-color: hsl(144, 6%, 69%);
      padding: 0 20px; box-sizing: border-box; z-index: 1000;
      border-bottom: 1px solid #f0f0f0;
    }
    .nav-left { display: flex; gap: 20px; flex: 1; height: 100%; align-items: flex-end; }
    .nav-center { flex: 0; display: flex; align-items: center; height: 100%; }
    .nav-center img { height: 35px; display: block; filter: brightness(1.2); }
    .nav-right { flex: 1; display: flex; justify-content: flex-end; align-items: center; height: 100%; }
    
    /* æŒ‰éˆ•èˆ‡åœ–æ¨™æ¨£å¼ */
    .nav-btn {
      font-size: 30px;
      background: none; border: none; padding: 0 5px 12px 5px;
      cursor: pointer; color: #000000; position: relative;
      transition: color 0.3s ease; display: flex; align-items: flex-end; height: 100%;
    }
    .nav-btn i, .nav-btn svg { width: 30px; height: 30px; }
    .nav-left .nav-btn::after {
      content: ""; position: absolute; bottom: -1px; left: 0; width: 0; height: 1px;
      background-color: #adadad; transition: width 0.3s ease;
    }
    .nav-left .nav-btn:hover { color: #947a7a; }
    .nav-left .nav-btn:hover::after { width: 100%; }
    .nav-right .api-link { color: #000000; text-decoration: none; display: flex; align-items: center; }
    .api-icon { width: 35px; height: 35px; }

    /* åˆ†å±¤æ§åˆ¶ CSS */
    body { padding-top: 85px; margin: 0; font-family: sans-serif; background-color: #f9f9f9; }
    .container { padding: 0 20px; }
    .page { display: none; animation: fadeIn 0.3s ease; } /* é è¨­å…¨éƒ¨éš±è— */
    .active { display: block; } /* é¡¯ç¤ºç•¶å‰åˆ†é  */

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* è¡¨æ ¼èˆ‡å¡ç‰‡æ¨£å¼ */
    .card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 15px; }
    .topping-group {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items: center; /* ç¢ºä¿åŒä¸€è¡Œçš„ç‰©ä»¶ä¸­å¿ƒé»å°é½Š */
}

.topping-item {
    cursor: pointer;
    padding: 8px 15px;
    border: 1px solid #ccc;
    border-radius: 20px;
    transition: all 0.3s;
    /* è®“æ¯å€‹æŒ‰éˆ•æœ‰æœ€å°å¯¬åº¦ï¼Œæ’åˆ—æœƒæ›´åƒæ ¼ç‹€ */
    min-width: 100px; 
    text-align: center;
    box-sizing: border-box; /* ç¢ºä¿ padding ä¸æœƒæ’å¤§å¯¬åº¦ */
}
/* ç•¶å‹¾é¸æ™‚ï¼Œæ”¹è®ŠèƒŒæ™¯é¡è‰² */
.topping-item:has(input:checked) {
  background-color: #556d6a;
  color: white;
  border-color: #597573;
}

/* éš±è—åŸå§‹çš„æ‰“å‹¾å°æ¡†æ¡† */
.topping-item input {
  display: none;
}

/* é¡åˆ¥å¤§æ¨™é¡Œ (ä¿æŒæ·±ç°è‰²) */
.category-title {
    background-color: #4a4a4a;
    color: white;
    text-align: center;
    padding: 12px;
    font-size: 1.2rem;
    margin: 0;
    letter-spacing: 2px;
}

/* è¡¨æ ¼è¡¨é ­ (åªæœ‰ ä¸­ / å¤§) */
.menu-header {
    display: grid;
    grid-template-columns: 1fr 1fr; /* è·Ÿä¸‹é¢çš„å…©æ¬„å°é½Š */
    background-color: #555;
    color: #eee;
    font-size: 0.8rem;
    column-gap: 1px;
}
.header-cell {
    padding: 5px 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: #7a6b6b;
}

.ml-tag {
    letter-spacing: 12px; /* è®“ M è·Ÿ L æ‹‰é–‹è·é›¢ï¼Œå°æº–ä¸‹é¢çš„æ•¸å­— */
    margin-right: 5px;
}

.drink-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;            /* ä½¿ç”¨è¼ƒèˆ’é©çš„å‚ç›´é–“è· */
    background-color: #ffffff;
    border-bottom: 1px solid #eee;
    transition: background-color 0.2s;
    min-height: 25px;              /* æ”¹ç”¨ min-heightï¼Œæ¯”å›ºå®š height æ›´æœ‰å½ˆæ€§ï¼Œå­—é«”å¤§æ™‚ä¸æœƒæº¢å‡º */
}
.drink-row:nth-child(even) {
    background-color: #fcfcfc;
}

.drink-item-name {
    font-size: 1.05rem;
    color: #333;
}

.menu-body {
    display: grid;
    grid-template-columns: 1fr 1fr; /* å¼·åˆ¶åˆ†æˆå…©æ¬„ */
    column-gap: 1px;                /* ä¸­é–“ç·šçš„å¯¬åº¦ */
}
.price-box {
    width: 30px;
    text-align: center;
    color: #444;
    font-size: 0.95rem;
}
/* 5. åƒ¹æ ¼ç¾¤çµ„çš„æ¨£å¼ */
.drink-item-price-group {
    display: flex;
    gap: 15px;
}

  </style>
</head>
<body>

  <nav class="navbar">
    <div class="nav-left">
      <button class="nav-btn" onclick="showPage('menuPage')" title="é£²å“èœå–®">
        <i class='bx bx-book-open'></i> 
      </button>
      <button class="nav-btn" onclick="showPage('orderPage')" title="æˆ‘è¦é»é¤">
        <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M9 5.5a.5.5 0 0 0-1 0V7H6.5a.5.5 0 0 0 0 1H8v1.5a.5.5 0 0 0 1 0V8h1.5a.5.5 0 0 0 0-1H9z"/><path d="M.5 1a.5.5 0 0 0 0 1h1.11l.401 1.607 1.498 7.985A.5.5 0 0 0 4 12h1a2 2 0 1 0 0 4 2 2 0 0 0 0-4h7a2 2 0 1 0 0 4 2 2 0 0 0 0-4h1a.5.5 0 0 0 .491-.408l1.5-8A.5.5 0 0 0 14.5 3H2.89l-.405-1.621A.5.5 0 0 0 2 1zm3.915 10L3.102 4h10.796l-1.313 7zM6 14a1 1 0 1 1-2 0 1 1 0 0 1 2 0m7 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0"/></svg>
      </button>
      <button class="nav-btn" onclick="showPage('historyPage')" title="æ­·å²è¨‚å–®">
        <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M5 4a.5.5 0 0 0 0 1h6a.5.5 0 0 0 0-1zm-.5 2.5A.5.5 0 0 1 5 6h6a.5.5 0 0 1 0 1H5a.5.5 0 0 1-.5-.5M5 8a.5.5 0 0 0 0 1h6a.5.5 0 0 0 0-1zm0 2a.5.5 0 0 0 0 1h3a.5.5 0 0 0 0-1z"/><path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2zm10-1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1"/></svg>
      </button>
    </div>

    <div class="nav-center">
      <img src="https://www.teamagichand.com.tw/images/logo2.png" alt="èŒ¶ä¹‹é­”æ‰‹">
    </div>

    <div class="nav-right">
      <a href="http://127.0.0.1:8000/docs" target="_blank" class="api-link" title="API æ–‡ä»¶">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="api-icon">
          <path stroke-linecap="round" stroke-linejoin="round" d="m6.75 7.5 3 2.25-3 2.25m4.5 0h3m-9 8.25h13.5A2.25 2.25 0 0 0 21 18V6a2.25 2.25 0 0 0-2.25-2.25H5.25A2.25 2.25 0 0 0 3 6v12a2.25 2.25 0 0 0 2.25 2.25Z" />
        </svg>
      </a>
    </div>
  </nav>

  <div class="container">
    <div id="menuPage" class="page active">
      <h2>é£²å“èœå–®</h2>
      <div id="menu"></div>
    </div>

    <div id="orderPage" class="page">
      <h2>é»é¤</h2>
      <div class="card">
        <form id="orderForm">
          <p>é¸æ“‡é£²æ–™ï¼š
      <select id="categorySelect" required>
        <option value="" disabled selected hidden>è«‹é¸æ“‡ç³»åˆ—...</option>
      </select>
    
      <select name="drink_name" id="drinkSelect" required>
        <option value="" disabled selected hidden>è«‹å…ˆé¸æ“‡ç³»åˆ—</option>
      </select>
      </p>
          <p>å°ºå¯¸ï¼š
            <select name="size" id="sizeSelect">
              <option value="M">M</option>
              <option value="L">L</option>
            </select>
          </p>
          <p>ç³–ï¼š
  <select name="sugar" id="sugarSelect" required>
    <option value="" disabled selected hidden>è«‹é¸æ“‡ç³–é‡</option>
  </select>
</p>

<p>å†°ï¼š
  <select name="ice" id="iceSelect" required>
    <option value="" disabled selected hidden>è«‹é¸æ“‡å†°é‡</option>
  </select>
</p>

<p>åŠ æ–™ (å¯å¤šé¸)ï¼š
  <div id="toppingSelect" class="topping-group">
    </div>
</p>
          
          <h3 id="pricePreview">ç›®å‰ç¸½åƒ¹ï¼š0 å…ƒ</h3>
          <button type="submit" style="padding: 10px 20px;">é€å‡ºè¨‚å–®</button>
        </form>
      </div>
      <div id="orderResult"></div>
    </div>

    <div id="historyPage" class="page">
      <h2>æ­·å²è¨‚å–®</h2>
      <p id="totalAmount">ç›®å‰æ‰€æœ‰è¨‚å–®ç¸½é‡‘é¡ï¼š0 å…ƒ</p>
      <div id="orders"></div>
    </div>
  </div>

<script>
    let menuData = {};

    // --- åˆ†é åˆ‡æ›é‚è¼¯ ---
    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        if(pageId === 'menuPage') loadMenu();
        if(pageId === 'historyPage') loadOrders();
    }

    // 1. è¼‰å…¥é£²å“èœå–®èˆ‡ç³»åˆ—
async function loadMenu() {
    try {
        const response = await fetch('http://127.0.0.1:8000/menu');
        const data = await response.json();
        menuData = data; 

        // --- 1. æ¸²æŸ“èœå–®é é¢ (å‡ç´šç‚ºå®˜ç¶²è¡¨æ ¼é¢¨æ ¼) ---
        const menuContainer = document.getElementById('menu');
        menuContainer.innerHTML = ''; 

        for (const category in data) {
            const section = document.createElement('div');
            section.className = 'menu-category-card'; // å¥—ç”¨æ–°çš„å¡ç‰‡æ¨£å¼
            let html = `
                <h3 class="category-title">${category}</h3>
                <div class="menu-header">
            <div class="header-cell">å“å <span class="ml-tag">M L</span></div>
            <div class="header-cell">å“å <span class="ml-tag">M L</span></div>
            </div>
                <div class="menu-body">
            `;
            
            // éæ­·è©²ç³»åˆ—çš„æ‰€æœ‰é£²å“
            for (const drink in data[category]) {
                const prices = data[category][drink];
                html += `
                <div class="drink-row">
                <div class="drink-item-name">${drink}</div>
                <div class="drink-item-price-group">
                    <span class="price-box">${prices.M}</span>
                    <span class="price-box">${prices.L}</span>
                </div>
            </div>                `;
            }
            
            html += `</div>`; // é—œé–‰ menu-body
            section.innerHTML = html;
            menuContainer.appendChild(section);
        }

        // --- 2. å¡«å……ç³»åˆ—ä¸‹æ‹‰é¸å–® (ä¿æŒä½ åŸæœ¬çš„é‚è¼¯) ---
        const categorySelect = document.getElementById('categorySelect');
        categorySelect.innerHTML = '<option value="" disabled selected hidden>è«‹é¸æ“‡ç³»åˆ—...</option>';        
        Object.keys(data).forEach(cat => {
            const opt = document.createElement('option');
            opt.value = cat;
            opt.textContent = cat;
            categorySelect.appendChild(opt);
        });
        


    } catch (error) {
        console.error("è¼‰å…¥èœå–®å¤±æ•—", error);
    }
}      
    // 2. è¼‰å…¥å†°å¡Šã€ç³–é‡ã€åŠ æ–™é¸é … (å¾ order_options æŠ“)
    async function loadOptions() {
        try {
            const response = await fetch('http://127.0.0.1:8000/options');
            const options = await response.json();

            // å¡«å……ç³–é‡
            const sugarSelect = document.getElementById('sugarSelect');
            sugarSelect.innerHTML = '<option value="" disabled selected hidden>è«‹é¸æ“‡ç³–é‡</option>';
            options["ç³–é‡"].forEach(level => {
                const opt = document.createElement('option');
                opt.value = level; opt.textContent = level;
                sugarSelect.appendChild(opt);
            });

            // å¡«å……å†°é‡
            const iceSelect = document.getElementById('iceSelect');
            iceSelect.innerHTML = '<option value="" disabled selected hidden>è«‹é¸æ“‡å†°é‡</option>';
            options["å†°é‡"].forEach(level => {
                const opt = document.createElement('option');
                opt.value = level; opt.textContent = level;
                iceSelect.appendChild(opt);
            });

            // å¡«å……åŠ æ–™å€
            const toppingContainer = document.getElementById('toppingSelect');
            toppingContainer.innerHTML = ''; 
            options["åŠ æ–™å€"].forEach(item => {
                const label = document.createElement('label');
                label.className = 'topping-item';
                label.innerHTML = `<input name="topping" type="checkbox" value="${item}"> ${item} (+10)`;
                toppingContainer.appendChild(label);
            });

        } catch (error) {
            console.error("è¼‰å…¥é¸é …å¤±æ•—", error);
        }
    }
      
    function updateDrinkOptions() {
        const category = document.getElementById('categorySelect').value;
        const drinkSelect = document.getElementById('drinkSelect');
        
        drinkSelect.innerHTML = '<option value="" disabled selected hidden>è«‹é¸æ“‡é£²å“</option>';
        if (category && menuData[category]) {
            Object.keys(menuData[category]).forEach(drink => {
                const opt = document.createElement('option');
                opt.value = drink; opt.textContent = drink;
                drinkSelect.appendChild(opt);
            });
        }
        updatePricePreview();
    }

function updatePricePreview() {
    const category = document.getElementById('categorySelect').value;
    const drink = document.getElementById('drinkSelect').value;
    const size = document.getElementById('sizeSelect').value;
    let basePrice = 0;

    // ç›´æ¥å®šä½ï¼šmenuData[ç³»åˆ—][é£²å“][å°ºå¯¸]
    if (category && drink && menuData[category] && menuData[category][drink]) {
        basePrice = menuData[category][drink][size] || 0;
    }

    const toppings = document.querySelectorAll('input[name="topping"]:checked');
    const total = basePrice + (toppings.length * 10);
    
    document.getElementById('pricePreview').innerText = `ç›®å‰ç¸½åƒ¹ï¼š${total} å…ƒ`;
}
    // ç›£è½å™¨
    document.getElementById('drinkSelect').addEventListener('change', updatePricePreview);
    document.getElementById('sizeSelect').addEventListener('change', updatePricePreview);
    document.getElementById('toppingSelect').addEventListener('change', updatePricePreview);

    // è¡¨å–®æäº¤
    document.getElementById('orderForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        const payload = {
            drink_name: fd.get('drink_name'),
            size: fd.get('size'),
            sugar: fd.get('sugar'),
            ice: fd.get('ice'),
            add: fd.getAll('topping') // é€™è£¡è¦å°æ‡‰ input çš„ name
        };

        const res = await fetch('http://127.0.0.1:8000/order', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        document.getElementById('orderResult').innerHTML = `<div class="card"><h3>è¨‚å–®æˆåŠŸï¼</h3><p>å–®è™Ÿï¼š#${data.id}ï¼Œé‡‘é¡ï¼š${data.total_price}å…ƒ</p></div>`;
        e.target.reset();
        updatePricePreview();
    });

    async function loadOrders() {
        const res = await fetch('http://127.0.0.1:8000/orders');
        const data = await res.json();
        // 1. ä¾æ—¥æœŸåˆ†é¡
    const groupedOrders = data.reduce((acc, order) => {
        // order.created_at æ˜¯ "2023-12-31 17:30:00"
        const [date, time] = order.created_at.split(' '); 
        if (!acc[date]) acc[date] = [];
        acc[date].push({ ...order, timeOnly: time });
        return acc;
    }, {});

    // 2. æ’åºæ—¥æœŸ (æœ€æ–°çš„åœ¨æœ€ä¸Šé¢)
    const sortedDates = Object.keys(groupedOrders).sort((a, b) => b.localeCompare(a));

    let html = '';
    let totalAmount = 0;

    sortedDates.forEach(date => {
        // æ¸²æŸ“æ—¥æœŸå€å¡Šæ¨™é¡Œ
        html += `<h3 class="date-header" style="margin: 20px 0 10px; color: #555;">ğŸ“… ${date}</h3>`;
        
        groupedOrders[date].forEach(o => {
            totalAmount += o.total_price;
            html += `
                <div class="card" style="margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between;">
                        <strong>#${o.id} ${o.drink_name} (${o.size})</strong>
                        <span style="color: #e67e22; font-weight: bold;">${o.total_price}å…ƒ</span>
                    </div>
                    <div style="font-size: 0.85em; color: #888; margin-top: 5px;">
                        ğŸ•’ ä¸‹å–®æ™‚é–“ï¼š${o.timeOnly} | ${o.sugar} / ${o.ice} ${o.add.length ? '/ ' + o.add.join(',') : ''}
                    </div>
                </div>`;
        });
    });

    document.getElementById('orders').innerHTML = html || '<p>å°šç„¡è¨‚å–®ç´€éŒ„</p>';
    document.getElementById('totalAmount').innerText = `ç›®å‰æ‰€æœ‰è¨‚å–®ç¸½é‡‘é¡ï¼š${totalAmount} å…ƒ`;
}
    // åˆå§‹åŒ–è¼‰å…¥
// åˆå§‹åŒ–è¼‰å…¥
window.onload = () => {
    loadMenu();
    loadOptions();

    // åœ¨é€™è£¡ç¶å®šä¸€æ¬¡å°±å¥½ï¼Œä¸è¦æ”¾åœ¨æœƒè¢«åè¦†åŸ·è¡Œçš„ loadMenu è£¡é¢
    const categorySelect = document.getElementById('categorySelect');
    categorySelect.addEventListener('change', updateDrinkOptions);
};</script>
</body>
</html>
